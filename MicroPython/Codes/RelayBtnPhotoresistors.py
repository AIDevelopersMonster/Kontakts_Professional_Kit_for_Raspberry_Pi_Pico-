# Video https://youtu.be/xUFz9EuGOl4
# Post http://kontakts.ru/showthread.php/40884?p=86197#post86197
# Telega https://t.me/MrMicroPython
from machine import Pin, ADC
import time

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ª–µ (GPIO 16)
relay = Pin(16, Pin.OUT)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ (GPIO 15, —Å –ø–æ–¥—Ç—è–∂–∫–æ–π PULL_UP)
button = Pin(15, Pin.IN, Pin.PULL_UP)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ç–æ—Ä–µ–∑–∏—Å—Ç–æ—Ä–∞ (ADC0 - GPIO26)
photoresistor = ADC(26)

# –§–ª–∞–≥ –≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ª–µ
auto_mode = False

# –ü–æ—Ä–æ–≥ –≤–∫–ª—é—á–µ–Ω–∏—è –∏ –≤—ã–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–ª–µ
THRESHOLD_ON = 2000   # –í–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∏–∂–µ 2000
THRESHOLD_OFF = 8000  # –í—ã–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç–∏ –≤—ã—à–µ 8000

# –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–ª–µ
relay_state = False

# –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ª–µ
def relay_on():
    global relay_state
    relay.value(1)
    relay_state = True

def relay_off():
    global relay_state
    relay.value(0)
    relay_state = False

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø—Ä–æ–≥—Ä–∞–º–º—ã
while True:
    # –ß–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å —Ñ–æ—Ç–æ—Ä–µ–∑–∏—Å—Ç–æ—Ä–∞
    light_level = photoresistor.read_u16()

    # –í—ã–≤–æ–¥ –≤ —Å–µ—Ä–∏–π–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä
    print(f"–û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å (A0): {light_level} | –†–µ–∂–∏–º: {'–ê–≤—Ç–æ' if auto_mode else '–í—ã–∫–ª'} | –†–µ–ª–µ: {'–í–ö–õ' if relay_state else '–í–´–ö–õ'}")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ (–∞–∫—Ç–∏–≤–Ω—ã–π LOW)
    if button.value() == 0:
        time.sleep(0.05)  # –î–µ–±–∞—É–Ω—Å
        if button.value() == 0:  # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            auto_mode = not auto_mode  # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
            print(f"–ê–≤—Ç–æ-—Ä–µ–∂–∏–º {'–≤–∫–ª—é—á–µ–Ω' if auto_mode else '–≤—ã–∫–ª—é—á–µ–Ω'}")
            
            # –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏
            while button.value() == 0:
                time.sleep(0.05)

    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ª–µ —Å –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–æ–º
    if auto_mode:
        if light_level < THRESHOLD_ON and not relay_state:  # –í–∫–ª—é—á–∞–µ–º —Ä–µ–ª–µ –ø—Ä–∏ —Ç–µ–º–Ω–æ—Ç–µ
            relay_on()
            print("üåô –¢–µ–º–Ω–æ! –†–µ–ª–µ –í–ö–õ–Æ–ß–ï–ù–û!")

        elif light_level > THRESHOLD_OFF and relay_state:  # –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–ª–µ –ø—Ä–∏ —Å–≤–µ—Ç–µ
            relay_off()
            print("‚òÄÔ∏è –°–≤–µ—Ç–ª–æ! –†–µ–ª–µ –í–´–ö–õ–Æ–ß–ï–ù–û!")
    else:
        relay_off()  # –ï—Å–ª–∏ –∞–≤—Ç–æ-—Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω, —Ä–µ–ª–µ –≤—Å–µ–≥–¥–∞ –≤—ã–∫–ª—é—á–µ–Ω–æ

    time.sleep(0.5)  # –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
